<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
    <script src="https://use.fontawesome.com/718410bc64.js"></script>
  </head>
  <body>
    <h1 style="text-align: center"><%= videoName %></h1>
    <div style="display: -webkit-flex; display: flex;">
      <div>
        <video id="presentation_video" width="800" height="450" controls>
          <source src="../videos/<%= videoName %>" type="video/mp4">
        </video>
        <hr>
        <canvas id="feedbackChart" width="600" height="100"></canvas>
      </div>
      <div style="height: 560px; margin-left: 20px; margin-right: 20px; -webkit-flex: 1; flex: 1; position: relative;">
        <ul id="feedback_prompt_tab" class="nav nav-pills" style="display: -webkit-flex; display: flex;">
          <li role="presentation" class="active" style="-webkit-flex: 1; flex: 1;">
            <a href="#feedback_list" aria-controls="feedback_list" role="tab" data-toggle="pill" style="text-align: center">Feedback</a></li>
          <li role="presentation" style="-webkit-flex: 1; flex: 1;">
            <a href="#prompt_list" aria-controls="prompt_list" role="tab" data-toggle="pill" style="text-align: center">Prompt</a></li>
        </ul>
        <div class="tab-content" style="width: 100%; height: 100%; position: absolute; border: 1px #337ab7 solid">
          <div role="tabpanel" class="tab-pane active" id="feedback_list">helo</div>
          <div role="tabpanel" class="tab-pane" id="prompt_list">
            <div style="text-align: center">
              <button type="button" class="btn btn-primary btn-lg" style="display: inline-block; margin-top: 20px; margin-bottom: 20px" data-toggle="modal" data-target="#new_prompt_modal">+</button>
            </div>
            <div id="prompt_list_body">
            </div>
          </div>
          <script type="text/javascript">
          updatePromptList();

          function updatePromptList() {
            let promptListElement = document.getElementById('prompt_list_body');
            let promptListRequest = new XMLHttpRequest();

            promptListRequest.onreadystatechange = () => {
              if (promptListRequest.readyState === 4) {
                if (promptListRequest.status === 200) {
                  console.log('prompt list request succeed!');

                  let promptList = JSON.parse(promptListRequest.responseText).prompt;
                  promptList.sort(comparePrompt);

                  for (let i = 0; i < promptList.length; i++) {
                    promptListElement.innerHTML += `<div class="panel panel-default" style="margin-bottom: 0">
                      <div class="panel-body" role="tab">
                        <h4 class="panel-title">
                          ${ '' + parseInt(promptList[i].time/60000) + ':' + parseInt((promptList[i].time%60000)/1000) } - ${ promptList[i].question }
                          <a style="float: right" data-toggle="collapse" href="#prompt_detail_${ i }" aria-expanded="true" aria-controls=""><i class="fa fa-angle-down" aria-hidden="true"></i></a>
                        </h4>
                      </div>
                      <div id="prompt_detail_${ i }" class="panel-collapse collapse" role="tabpanel">
                        <div id="prompt_detail_body_${ i }" class="panel-body">
                          <p style="text-align: center">Answers</h5>
                        </div>
                      </div>
                    </div>`

                    let promptDetailBodyElement = document.getElementById('prompt_detail_body_' + i);
                    for (let j = 0; j < promptList[j].answers.length; j++) {
                      let promptAnswerElement = document.createElement('p');
                      promptAnswerElement.style.marginBottom = 5;
                      promptAnswerElement.innerHTML = promptList[i].answers[j].answer;
                      promptDetailBodyElement.appendChild(promptAnswerElement);
                    }
                  }
                }
              }
            }
            // newPromptRequest.open('POST', 'http://emma.kaist.ac.kr:3000/new_prompt/<%= videoName %>', true);
            promptListRequest.open('GET', 'http://192.168.1.144:3000/get_prompt/<%= videoName %>', true);
            promptListRequest.send(null);
          }

          function comparePrompt(prompt1, prompt2) {
            if (prompt1.time < prompt2.time) return -1;
            else if (prompt1.time > prompt2.time) return 1;
            else return 0;
          }
          </script>
        </div>
        <script type="text/javascript">
          $('#feedback_prompt_tab a').click(function(e) {
            e.preventDefault();
            $(this).tab('show');
          });
        </script>
      </div>
    </div>
    <div class="modal fade" id="new_prompt_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" style="text-align: center">Create new prompt</h4>
          </div>
          <div class="modal-body">
            <ul id="new_prompt_type_tab" class="nav nav-pills" style="display: -webkit-flex; display: flex;">
              <li id="custom_question_tab" role="presentation" class="active" style="-webkit-flex: 1; flex: 1;">
                <a href="#custom_question_form" aria-controls="custom_question_form" role="tab" data-toggle="pill" style="text-align: center;">Custom question</a>
              </li>
              <li id="ab_testing_tab" role="presentation" style="-webkit-flex: 1; flex: 1;">
                <a href="#ab_testing_form" aria-controls="ab_testing_form" role="tab" data-toggle="pill" style="text-align: center;">A-B testing</a>
              </li>
            </ul>
            <div class="tab-content">
              <div role="tabpanel" class="tab-pane active" id="custom_question_form" style="margin-top: 20px">
                <form>
                  <div class="form-group">
                    <label for="custom_question_prompt_time">Time to pop up</label>
                    <div class="input-group">
                      <input type="number" min="0" max="59" class="form-control" id="custom_question_prompt_time_min" placeholder="0">
                      <div class="input-group-addon">:</div>
                      <input type="number" min="0" max="59" class="form-control" id="custom_question_prompt_time_sec" placeholder="00">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="custom_question_prompt_question">Question</label>
                    <input type="text" class="form-control" id="custom_question_prompt_question" placeholder="Type your question">
                  </div>
                </form>
              </div>
              <div role="tabpanel" class="tab-pane" id="ab_testing_form">
                hello
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="button" id="new_prompt_submit_btn" class="btn btn-primary" data-dismiss="modal">Submit</button>
          </div>
        </div>
      </div>
    </div>
    <script type="text/javascript">
      $('#new_prompt_type_tab a').click(function(e) {
        e.preventDefault();
        $(this).tab('show');
      });

      $('#new_prompt_submit_btn').click(function(e) {
        console.log('pressed');
        let newPromptRequest = new XMLHttpRequest();
        let promptType;
        if (document.getElementById('custom_question_tab').classList.contains('active')) promptType = 0;
        else if (document.getElementById('ab_testing_tab').classList.contains('active')) promptType = 1;
        else promptType = 2;
        let promptTime = Number($('#custom_question_prompt_time_min').val()) * 60000 + Number($('#custom_question_prompt_time_sec').val()) * 1000;
        let postData = {
          type: promptType,
          time: promptTime,
          question: $('#custom_question_prompt_question').val(),
        };
        console.log(JSON.stringify(postData));

        newPromptRequest.onreadystatechange = () => {
          if (newPromptRequest.readyState === 4) {
            if (newPromptRequest.status === 200) {
              console.log('new prompt request succeed!');
              updatePromptList();
            }
          }
        }
        // newPromptRequest.open('POST', 'http://emma.kaist.ac.kr:3000/new_prompt/<%= videoName %>', true);
        newPromptRequest.open('POST', 'http://192.168.1.144:3000/new_prompt/<%= videoName %>', true);
        newPromptRequest.send(JSON.stringify(postData));
      });
    </script>
    <script type="text/javascript">
      let videoElement = document.getElementById('presentation_video');
      let feedbackListElement = document.getElementById('feedback_list');
      let timeIntervalElement = document.getElementById('time_interval');
      let feedbackList = [];
      let httpRequest = new XMLHttpRequest();
      httpRequest.onreadystatechange = () => {
        if (httpRequest.readyState === 4) {
          if (httpRequest.status === 200) {
            console.log('http request succeed!');
            feedbackList = JSON.parse(httpRequest.responseText).feedback;
            feedbackList.sort(compareFeedback);
            appendFeedbackList(feedbackList);
          }
        }
      }
      // httpRequest.open('GET', 'http://emma.kaist.ac.kr:3000/get_feedback/<%= videoName %>', true);
      httpRequest.open('GET', 'http://192.168.1.144:3000/get_feedback/<%= videoName %>', true);
      httpRequest.send(null);

      function appendFeedbackList(feedbackList) {
        $( feedbackListElement ).empty();

        for (let i = 0; i < feedbackList.length; i++) {
          let startTime = feedbackList[i].startTime;
          let startTimeText = '' + parseInt(startTime/60000) + ':' + parseInt((startTime%60000)/1000);
          feedbackListElement.innerHTML += `<div class="panel panel-default" style="margin-bottom: 0">
            <div class="panel-body" role="tab">
              <h4 id="feedback_${ i }" class="panel-title">
                ${ startTimeText + ' - ' + feedbackList[i].feedback }
                <a style="float: right" data-toggle="collapse" href="#thread_feedback_${ i }" aria-expanded="true" aria-controls=""><i class="fa fa-angle-down" aria-hidden="true"></i></a>
              </h4>
            </div>
            <div id="thread_feedback_${ i }" class="panel-collapse collapse" role="tabpanel">
              <div id="thread_feedback_body_${ i }"class="panel-body">
              </div>
            </div>
          </div>`

          // console.log($('#feedback_' + i));

          // $('#feedback_' + i).click(function(e) {
          //   console.log('feedback clicked: ' + i);
          //   videoElement.currentTime = startTime/1000;
          // });

          if (feedbackList[i].thread.length !== 0) {
            let threadFeedbackBodyElement = document.getElementById('thread_feedback_body_' + i);
            for (let j = 0; j < feedbackList[i].thread.length; j++) {
              let threadFeedbackElement = document.createElement('span');
              let threadFeedbackStr = feedbackList[i].thread[j].feedback;
              // if (feedbackList[i].thread[j].like.length !== 0)
              //   threadFeedbackStr += ' (+' + feedbackList[i].thread[j].like.length + ')';
              threadFeedbackStr += '<br>';
              threadFeedbackElement.innerHTML = threadFeedbackStr;
              threadFeedbackBodyElement.appendChild(threadFeedbackElement);
            }
          }





          // let feedbackListItemElement = document.createElement('div');
          // let feedbackElement = document.createElement('span');
          // let threadElement = document.createElement('div');
          // let feedbackStr = startTimeText + ' - ' + feedbackList[i].feedback;
          // console.log(feedbackList[i].like);
          // if (feedbackList[i].like.length !== 0)
          //   feedbackStr += ' (+' + feedbackList[i].like.length + ')';
          // feedbackElement.innerHTML = feedbackStr;
          // feedbackListItemElement.addEventListener('click', () => {
          //   videoElement.currentTime = startTime/1000;
          // });
          // feedbackListItemElement.appendChild(feedbackElement);
          //
          // if (feedbackList[i].thread.length !== 0) {
          //   for (let j = 0; j < feedbackList[i].thread.length; j++) {
          //     let threadFeedbackElement = document.createElement('span');
          //     let threadFeedbackStr = feedbackList[i].thread[j].feedback;
          //     if (feedbackList[i].thread[j].like.length !== 0)
          //       threadFeedbackStr += ' (+' + feedbackList[i].thread[j].like.length + ')';
          //     threadFeedbackStr += '<br>';
          //     threadFeedbackElement.innerHTML = threadFeedbackStr;
          //     threadElement.appendChild(threadFeedbackElement);
          //   }
          //
          //   threadElement.style.marginLeft = "30px";
          //   feedbackListItemElement.appendChild(threadElement);
          // }
          //
          // feedbackListElement.appendChild(feedbackListItemElement);
        }

        for (let i = 0; i < feedbackList.length; i++) {
          $('#feedback_' + i).click((e) => {
            videoElement.currentTime = feedbackList[i].startTime/1000;
          });
        }
      }

      function compareFeedback(feedback1, feedback2) {
        if (feedback1.startTime < feedback2.startTime) return -1;
        else if (feedback1.startTime > feedback2.startTime) return 1;
        else {
          if (feedback1.endTime < feedback2.endTime) return -1;
          else if (feedback1.endTime > feedback2.endTime) return -1;
          else return 0;
        }
      }
    </script>
    <script>
      videoElement.addEventListener('loadedmetadata', function() {
        let ctx = document.getElementById("feedbackChart");
        let dataLabels = [];
        let dataData = [];
        let timeCnt = 0;
        let videoLength = Math.round(videoElement.duration*1000);
        let intervalNum = Math.round(videoLength / 10000)
        let timeInterval = Math.round(videoLength / intervalNum);
        console.log(videoLength);
        console.log(timeInterval);

        for (let i = 0; i <= intervalNum; i++) {
          let startTime = timeCnt - timeInterval/2;
          let endTime = timeCnt + timeInterval/2 < videoLength ? timeCnt + timeInterval/2 : videoLength;
          let feedbackCnt = 0;
          for (let i = 0; i < feedbackList.length; i++) {
            if (timeIntervalOverlap(startTime, endTime, feedbackList[i])) {
              feedbackCnt++;
            }
          }

          dataLabels.push('' + Math.floor(timeCnt/60000) + ':' + Math.floor((timeCnt%60000) / 1000));
          dataData.push(feedbackCnt);
          timeCnt += timeInterval;
        }
        console.log(dataLabels);
        console.log(dataData);

        let myChart = new Chart(ctx, {
          type: 'line',
          data: {
              labels: dataLabels,
              datasets: [{
                  label: '# of Feedback',
                  data: dataData,
                  backgroundColor: 'rgba(255, 99, 132, 0.2)',
                  borderColor: 'rgba(255,99,132,1)',
                  borderWidth: 1,
                  pointRadius: 10,
                  pointHoverRadius: 12,
                  pointHitRadius: 10,
              }]
          },
          options: {
            onClick: onGraphClick,
            layout: {
              padding: {
                left: 50,
                right: 50,
                top: 0,
                bottom: 0
              }
            },
            scales: {
              xAxis: [{
                gridLines: {
                  display: false
                },
                type: 'time',
                time: {
                  displayFormats: {
                    second: 'mm:ss a'
                  }
                }
              }],
              yAxes: [{
                gridLines: {
                  display: false
                },
                ticks: {
                  beginAtZero:true
                }
              }]
            }
          }
        });

        function timeIntervalOverlap(startTime, endTime, feedback) {
          if ((startTime < feedback.startTime && endTime > feedback.endTime)
            || (startTime > feedback.startTime && startTime < feedback.endTime)
            || (endTime > feedback.startTime && endTime < feedback.endTime))
            return true;
          else return false;
        }

        function onGraphClick(event, elements) {
          console.log(event);
          console.log(elements);
          if (elements.length !== 0) {
            let chartElement = elements[0];
            let timeToGo = timeInterval * chartElement._index;
            // videoElement.removeEventListener('timeupdate', onTimeUpdateListener);
            videoElement.currentTime = timeToGo / 1000;
            // appendFeedbackList(getFeedbackForSection(chartElement._index));
            // timeIntervalElement.innerHTML = 'Around ' + Math.floor(timeToGo / 60000) + ':' + Math.floor((timeToGo % 60000) / 1000);
            // videoElement.addEventListener('timeupdate', onTimeUpdateListener);

            function onTimeUpdateListener(e) {
              const currTimeToGo = timeToGo + 0;
              if (videoElement.currentTime * 1000 > currTimeToGo + timeInterval / 2
                || videoElement.currentTime * 1000 < currTimeToGo - timeInterval / 2) {
                timeIntervalElement.innerHTML = 'All';
                appendFeedbackList(feedbackList);
                videoElement.removeEventListener('timeupdate', onTimeUpdateListener);
              }
            }
          }
        }

        function getFeedbackForSection(index) {
          let startTime = timeInterval * index - timeInterval / 2;
          let endTime = timeInterval * index + timeInterval / 2;
          let feedbackForSection = [];
          for (let i = 0; i < feedbackList.length; i++) {
            if (timeIntervalOverlap(startTime, endTime, feedbackList[i])) {
              feedbackForSection.push(feedbackList[i]);
            }
          }

          return feedbackForSection;
        }
      });
    </script>
  </body>
</html>
